@page "/catalog"
@using OnlineBookShop.Components.Pages.Models
@inject NavigationManager Navigation
@inject StoreDbContext Db


<link href="lib/bootstrap/dist/css/Catalog.css" rel="stylesheet"/>

<div class="book-list">
    @if (_books != null && _books.Any())
    {
        foreach (var book in _books)
        {
            <div class="book-card" @onclick="() => OpenModal(book)">
                <img src="@book.CoverImage" alt="@book.Title" />
                <div class="book-info">
                    <h4>@book.Title</h4>
                    <p class="author">@book.Author</p>
                    <p class="price">@book.Price.ToString("0.00") ₴</p>
                </div>
            </div>
        }
    }
    else
    {
        <p>Книги не знайдено</p>
    }
</div>

@if (SelectedBook != null)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="custom-modal" @onclick:stopPropagation>
            <div class="modal-top">
                <button class="back-btn" @onclick="CloseModal">
                    <i class="bi bi-arrow-left"></i>
                </button>
            </div>
            <div class="row">
                <div class="col-md-4 image-box">
                    <img src="@SelectedBook.CoverImage" alt="@SelectedBook.Title" />
                </div>
                <div class="col-md-8 info-box">
                    <h2>@SelectedBook.Title</h2>
                    <p class="author">@SelectedBook.Author</p>
                    <p class="price">@SelectedBook.Price.ToString("0.00") ₴</p>

                    <div class="description-block">
                        <h5>Опис</h5>
                        <p>@SelectedBook.Description</p>
                    </div>

                    <div class="d-flex gap-2 mt-3">
                        <input type="text" placeholder="Ваш відгук..." class="form-control review-input" />
                        <button class="btn btn-primary add-cart-btn">Додати в кошик</button>
                        <button class="btn heart-btn">
                            <i class="bi @(isFavorite ? "bi-heart-fill" : "bi-heart")"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public Book? SelectedBook { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }    // викликається при закритті модалки
    private List<Book>? _books;
    private string searchQuery = "";
    private IEnumerable<Book> filteredBooks =>
        string.IsNullOrWhiteSpace(searchQuery)
            ? _books
            : _books.Where(b => b.Title.Contains(searchQuery, StringComparison.OrdinalIgnoreCase));
    
    private bool isFavorite = false;
    private string newReview = "";
    
    protected override void OnInitialized()
    {
        _books = Db.books.ToList();
    }


    private async Task OnBackClicked()
    {
        // РЕКОМЕНДАЦІЯ: закривати модалку через EventCallback (батьківський компонент видалить SelectedBook)
        if (OnClose.HasDelegate)
        {
            await OnClose.InvokeAsync(null);
            return;
        }

        // Якщо OnClose не передали — як fallback можна перейти на сторінку (не обов'язково)
        Navigation.NavigateTo("/catalog");
    }

    private void OpenModal(Book book)
    {
        SelectedBook = book;
    }

    private void CloseModal()
    {
        SelectedBook = null;
    }
    
    private async Task CloseByOverlay()
    {
        // клік по тлу закриває вікно
        await OnBackClicked();
    }

    private void ToggleFavorite()
    {
        isFavorite = !isFavorite;
        // тут можна викликати сервіс/запит для збереження обраного
    }

    private void AddToCart()
    {
        // додати логіку додавання в кошик
    }
}



@*@page "/catalog"
@inject HttpClient Http

<h1 class="text-3xl font-bold mb-4">Каталог книг</h1>

<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <select class="p-2 border rounded" @onchange="OnGenreChange">
        <option value="">Усі жанри</option>
        @foreach (var genre in _genres.Distinct())
        {
            <option value="@genre">@genre</option>
        }
    </select>
    <select class="p-2 border rounded" @onchange="OnAuthorChange">
        <option value="">Усі автори</option>
        @foreach (var author in _authors.Distinct())
        {
            <option value="@author">@author</option>
        }
    </select>
    <select class="p-2 border rounded" @onchange="OnPriceSortChange">
        <option value="">Сортувати за</option>
        <option value="asc">Ціною (зростання)</option>
        <option value="desc">Ціною (спадання)</option>
    </select>
</div>

@if (_books == null)
{
    <p>Завантаження книжок...</p>
}
else if (_books.Count == 0)
{
    <p>Не було знайдено книг за вашими фільтрами .</p>
}
else
{
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        @foreach (var book in _books)
        {
            <div class="border rounded p-4 shadow-md">
                <h3 class="font-semibold text-xl mb-2">@book.Title</h3>
                <p class="text-sm text-gray-700">Автор: @book.Author</p>
                <p class="text-sm text-gray-700">Жанр: @book.Genre</p>
                <p class="text-lg font-bold mt-2">@book.Price ₴</p>
            </div>
        }
    </div>
}

@code {
    private List<BookModel>? _books;
    private List<string> _genres = new();
    private List<string> _authors = new();
    private string _selectedGenre = "";
    private string _selectedAuthor = "";
    private string _priceSort = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadBooks();
    }

    private async Task LoadBooks()
    {
        var result = await Http.GetFromJsonAsync<List<BookModel>>("api/books");
        if (result != null)
        {
            _books = result;
            _genres = _books.Select(b => b.Genre).Distinct().ToList();
            _authors = _books.Select(b => b.Author).Distinct().ToList();
            ApplyFilters();
        }
    }

    private void ApplyFilters()
    {
        if (_books == null) return;

        var filtered = _books.AsEnumerable();

        if (!string.IsNullOrEmpty(_selectedGenre))
            filtered = filtered.Where(b => b.Genre == _selectedGenre);

        if (!string.IsNullOrEmpty(_selectedAuthor))
            filtered = filtered.Where(b => b.Author == _selectedAuthor);

        if (_priceSort == "asc")
            filtered = filtered.OrderBy(b => b.Price);
        else if (_priceSort == "desc")
            filtered = filtered.OrderByDescending(b => b.Price);

        _books = filtered.ToList();
    }

    private void OnGenreChange(ChangeEventArgs e)
    {
        _selectedGenre = e.Value?.ToString() ?? "";
        ApplyFilters();
    }

    private void OnAuthorChange(ChangeEventArgs e)
    {
        _selectedAuthor = e.Value?.ToString() ?? "";
        ApplyFilters();
    }

    private void OnPriceSortChange(ChangeEventArgs e)
    {
        _priceSort = e.Value?.ToString() ?? "";
        ApplyFilters();
    }

    public class BookModel
    {
        public int Id { get; set; }
        public string Title { get; set; } = "";
        public string Author { get; set; } = "";
        public string Genre { get; set; } = "";
        public decimal Price { get; set; }
    }
}*@
